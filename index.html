<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Previs√£o 15 dias - ECMWF</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --fg: #000000;
            --muted: #333333;
            --card: #f6f6f6
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: 'Ubuntu', sans-serif;
            background: var(--bg);
            color: var(--fg);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 28px;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            gap: 14px;
            align-items: baseline;
            flex-wrap: wrap;
        }

        .brand h1 {
            font-size: 35px;
            margin: 0;
            font-weight: 700;
            letter-spacing: 0.2px
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type=text] {
            padding: 12px 14px;
            border: 1px solid var(--muted);
            background: #fefefe;
            color: var(--fg);
            font-size: 14px;
            min-width: 220px;
            flex: 1;
            border-radius: 8px;
            transition: all 0.25s ease;
            font-family: 'Ubuntu', sans-serif;
            text-align: center;
        }

        input[type=text]:focus {
            outline: none;
            border-color: var(--fg);
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 12px 18px;
            border: 1px solid var(--fg);
            background: var(--fg);
            color: var(--bg);
            cursor: pointer;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.25s ease;
            font-family: 'Ubuntu', sans-serif;
        }

        #geoButton {
            background: var(--fg);
            color: var(--bg);
        }

        .meta {
            font-size: 18px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .fonte-dados {
            font-size: 18px;
        }

        main {
            display: block
        }

        .location-row {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-top: 50px;
            margin-bottom: 50px;
            flex-wrap: wrap;
        }

        #locationName {
            font-size: 20px;
        }

        .cards {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            row-gap: 60px;
        }

        .card {
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card .date {
            font-size: 22px;
            font-weight: 700;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 6px 0;
        }

        .row p {
            margin: 0;
            line-height: 1.3;
            font-size: 18px;
        }

        .row-text {
            color: rgb(0, 0, 0);
        }

        .row-data p {
            font-size: 18px;
            padding: 6px 15px;
            border-radius: 12px;
        }

        footer {
            margin-top: 18px;
            font-size: 13px;
            color: var(--muted)
        }

        @media (max-width:1000px) {

            body {
                padding: 15px 8px;
            }

            header {
                display: grid;
                justify-content: center;
                justify-items: center;
                text-align: center;
            }

            input[type=text] {
                min-width: 100%;
                margin-bottom: 5px;
            }

            button {
                width: 100%;
                margin-bottom: 5px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .location-row {
                align-items: center;
                gap: 12px;
            }

            #locationName {
                margin: auto;
                font-size: 14px;
            }

            .location-row>div:last-child {
                margin-left: 0 !important;
                text-align: center !important;
                width: 100%;
            }

            .cards {
                display: grid;
                grid-template-columns: 1fr;
                gap: 80px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">
            <h1>Previs√£o - 15 dias</h1>
        </div>
        <div class="controls">
            <form id="searchForm">
                <input type="text" id="cityInput" placeholder="Buscar cidade (ex: Recife, BR)"
                    aria-label="Buscar cidade" />
                <button type="submit">Buscar</button>
                <button type="button" id="geoButton" title="Usar minha localiza√ß√£o">Localizar</button>
            </form>
        </div>
    </header>

    <main>
        <div class="location-row">
            <div id="locationName" style="font-weight:700"></div>
            <div
                style="margin-left:auto;text-align:right;background-color: rgb(255, 237, 224);border-radius: 10px;padding: 10px;">
                <div class="meta">Hoje: <span id="todayDate"></span></div>
                <div class="fonte-dados">Dados: Open-Meteo (modelo ecmwf_ifs)</div>
            </div>
        </div>
        <section id="forecastSection">
            <div class="cards" id="cards"></div>
        </section>
    </main>

    <script>
        const forecastBase = 'https://api.open-meteo.com/v1/forecast';
        const model = 'ecmwf_ifs';

        const cityInput = document.getElementById('cityInput');
        const searchForm = document.getElementById('searchForm');
        const locationName = document.getElementById('locationName');
        const cardsEl = document.getElementById('cards');
        const todayDate = document.getElementById('todayDate');

        const today = new Date();
        const weekday = new Intl.DateTimeFormat('pt-BR', { weekday: 'long' }).format(today);
        const date = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit' }).format(today);
        todayDate.textContent = `${date} - ${weekday}`;

        // --- Helpers ---
        function formatDateLabel(iso) {
            const d = new Date(iso);
            const weekday = new Intl.DateTimeFormat('pt-BR', { weekday: 'short' }).format(d);
            const date = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit' }).format(d);
            return { weekday, date };
        }

        function groupHourlyByDate(times, arrays) {
            const map = new Map();
            for (let i = 0; i < times.length; i++) {
                const day = times[i].slice(0, 10);
                if (!map.has(day)) map.set(day, []);
                const point = {};
                for (const key in arrays) { point[key] = arrays[key][i]; }
                point.time = times[i];
                map.get(day).push(point);
            }
            return map;
        }

        function summarizeDay(points) {
            let tMin = Infinity, tMax = -Infinity, rhMin = Infinity, rhMax = -Infinity;
            let precipSum = 0, gustMax = 0;
            let clouds = { madrugada: [], manha: [], tarde: [], noite: [] };

            for (const p of points) {
                const hour = new Date(p.time).getHours();
                if (p.temperature_2m != null) {
                    if (p.temperature_2m < tMin) tMin = p.temperature_2m;
                    if (p.temperature_2m > tMax) tMax = p.temperature_2m;
                }
                if (p.relative_humidity_2m != null) {
                    if (p.relative_humidity_2m < rhMin) rhMin = p.relative_humidity_2m;
                    if (p.relative_humidity_2m > rhMax) rhMax = p.relative_humidity_2m;
                }
                if (p.precipitation != null) precipSum += p.precipitation;
                if (p.wind_gusts_10m != null && p.wind_gusts_10m > gustMax) gustMax = p.wind_gusts_10m;
                if (p.cloud_cover != null) {
                    if (hour >= 0 && hour < 6) clouds.madrugada.push(p.cloud_cover);
                    else if (hour >= 6 && hour < 12) clouds.manha.push(p.cloud_cover);
                    else if (hour >= 12 && hour < 18) clouds.tarde.push(p.cloud_cover);
                    else clouds.noite.push(p.cloud_cover);
                }
            }

            const avg = arr => arr.length ? arr.reduce((a, b) => a + b) / arr.length : 0;

            return {
                tMin,
                tMax,
                rhMin,
                rhMax,
                precipSum,
                gustMax,
                clouds: {
                    madrugada: avg(clouds.madrugada),
                    manha: avg(clouds.manha),
                    tarde: avg(clouds.tarde),
                    noite: avg(clouds.noite)
                }
            };
        }

        // --- Render ---
        function renderDays(dayMap) {
            cardsEl.innerHTML = '';
            const entries = Array.from(dayMap.entries()).slice(0, 15);

            for (const [day, points] of entries) {
                const iso = day + 'T00:00:00';
                const labels = formatDateLabel(iso);
                const s = summarizeDay(points);

                const card = document.createElement('div');
                card.className = 'card';

                card.innerHTML = `
                    <div class="date">${labels.date} (${labels.weekday})</div>

                    <div class="row" style="background-color: #ffeac9; padding: 10px; border-radius: 8px">
                        <div class="row-text"><p>Temperatura (¬∞C)</p></div>
                        <div class="row-data">
                            <p>${isFinite(s.tMin) ? s.tMin.toFixed(0) : '-'} a ${isFinite(s.tMax) ? s.tMax.toFixed(0) : '-'}</p>
                        </div>
                    </div>

                    <div class="row" style="background-color: #c9efff; padding: 10px; border-radius: 8px">
                        <div class="row-text"><p>Precipita√ß√£o (mm)</p></div>
                        <div class="row-data">
                            <p>${s.precipSum.toFixed(1)}</p>
                        </div>
                    </div>

                    <div class="row" style="background-color: #c9efff; padding: 10px; border-radius: 8px"> 
                        <div class="row-text" ><p>Umidade (%)</p></div>
                        <div class="row-data">
                            <p>${isFinite(s.rhMin) ? s.rhMin.toFixed(0) : '-'} a ${isFinite(s.rhMax) ? s.rhMax.toFixed(0) : '-'}</p>
                        </div>
                    </div>

                    <div class="row" style="background-color: #cfffc9; padding: 10px; border-radius: 8px">
                        <div class="row-text" ><p>Rajadas de vento (km/h)</p></div>
                        <div class="row-data">
                            <p>${s.gustMax.toFixed(0)}</p>
                        </div>
                    </div>


                    <div class="row" style="background-color: #ebebeb; padding: 10px; border-radius: 8px">
                        <div class="row-text"><p>Nuvens de madrugada (%)</p></div>
                        <div class="row-data">
                            <p>
                               ${s.clouds.madrugada.toFixed(0)}<br>
                            </p>
                        </div>
                    </div>

                    <div class="row" style="background-color: #ebebeb; padding: 10px; border-radius: 8px">
                        <div class="row-text"><p>Nuvens de manh√£ (%)</p></div>
                        <div class="row-data">
                            <p>
                                ${s.clouds.manha.toFixed(0)}<br>
                            </p>
                        </div>
                    </div>

                    <div class="row" style="background-color: #ebebeb; padding: 10px; border-radius: 8px">
                        <div class="row-text"><p>Nuvens √† tarde (%)</p></div>
                        <div class="row-data">
                            <p>
                                ${s.clouds.tarde.toFixed(0)}<br>
                            </p>
                        </div>
                    </div>

                    <div class="row" style="background-color: #ebebeb; padding: 10px; border-radius: 8px">
                        <div class="row-text"><p>Nuvens √† noite (%)</p></div>
                        <div class="row-data">
                            <p>
                                ${s.clouds.noite.toFixed(0)}
                            </p>
                        </div>
                    </div>
                `;

                cardsEl.appendChild(card);
            }
        }

        // --- Fetch ---
        async function fetchForecast(lat, lon, timezone = 'auto') {
            const url = new URL(forecastBase);
            url.searchParams.set('latitude', lat);
            url.searchParams.set('longitude', lon);
            url.searchParams.set('hourly', 'temperature_2m,relative_humidity_2m,precipitation,cloud_cover,wind_gusts_10m');
            url.searchParams.set('models', model);
            url.searchParams.set('timezone', timezone);
            url.searchParams.set('forecast_days', '15');
            const res = await fetch(url.toString());
            if (!res.ok) throw new Error('Erro ao buscar previs√£o');
            return await res.json();
        }

        // --- Search ---
        async function searchLocation(query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(query)}&limit=1`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Erro ao buscar localiza√ß√£o');
            const data = await res.json();
            if (!data[0] || !data[0].lat) throw new Error('Local n√£o encontrado');
            const place = data[0];
            const addr = place.address || {};
            const city = addr.city || addr.town || addr.village || addr.municipality || '';
            const state = addr.state || '';
            const country = addr.country || '';
            locationName.textContent = `üìå ${city}${state ? ', ' + state : ''}${country ? ' - ' + country : ''}`;
            return { lat: parseFloat(place.lat), lon: parseFloat(place.lon) };
        }

        // --- Event listeners ---
        searchForm.addEventListener('submit', async e => {
            e.preventDefault();
            const q = cityInput.value.trim();
            if (!q) return;
            try {
                locationName.textContent = 'Buscando...';
                cardsEl.innerHTML = '';
                const { lat, lon } = await searchLocation(q);
                const forecast = await fetchForecast(lat, lon);
                const times = forecast.hourly.time;
                const arrays = {
                    temperature_2m: forecast.hourly.temperature_2m || [],
                    relative_humidity_2m: forecast.hourly.relative_humidity_2m || [],
                    precipitation: forecast.hourly.precipitation || [],
                    cloud_cover: forecast.hourly.cloud_cover || [],
                    wind_gusts_10m: forecast.hourly.wind_gusts_10m || []
                };
                const dayMap = groupHourlyByDate(times, arrays);
                renderDays(dayMap);
                cityInput.value = '';
            } catch (err) {
                console.error(err);
                locationName.textContent = 'Erro ao carregar';
            }
        });

        const geoButton = document.getElementById('geoButton');
        geoButton.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Geolocaliza√ß√£o n√£o √© suportada neste navegador.');
                return;
            }
            locationName.textContent = 'Obtendo sua localiza√ß√£o...';
            cardsEl.innerHTML = '';

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                try {
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=${latitude}&lon=${longitude}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    const addr = data.address || {};
                    const city = addr.city || addr.town || addr.village || addr.municipality || '';
                    const state = addr.state || '';
                    const country = addr.country || '';
                    locationName.textContent = `üìå ${city}${state ? ', ' + state : ''}${country ? ' - ' + country : ''}`;

                    const forecast = await fetchForecast(latitude, longitude);
                    const times = forecast.hourly.time;
                    const arrays = {
                        temperature_2m: forecast.hourly.temperature_2m || [],
                        relative_humidity_2m: forecast.hourly.relative_humidity_2m || [],
                        precipitation: forecast.hourly.precipitation || [],
                        cloud_cover: forecast.hourly.cloud_cover || [],
                        wind_gusts_10m: forecast.hourly.wind_gusts_10m || []
                    };
                    const dayMap = groupHourlyByDate(times, arrays);
                    renderDays(dayMap);
                } catch (err) {
                    console.error(err);
                    locationName.textContent = 'Erro ao obter previs√£o pela localiza√ß√£o.';
                }
            }, (err) => {
                console.error(err);
                locationName.textContent = 'Permiss√£o negada ou erro ao obter localiza√ß√£o.';
            });
        });
    </script>

</body>

</html>